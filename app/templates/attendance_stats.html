{% extends "base.html" %} {% block content %}
<div class="row">
  <div class="col-12">
    <h2 class="text-white mb-4">
      <i class="bi bi-graph-up-arrow"></i> Estadísticas de Asistencia
    </h2>
  </div>
</div>

<!-- Período -->
<div class="row mb-4">
  <div class="col-12">
    <div class="alert alert-info">
      <i class="bi bi-calendar-range"></i>
      <strong>Período de análisis:</strong>
      Semana actual desde {{ week_start.strftime('%d/%m/%Y') }} | Mes actual
      desde {{ month_start.strftime('%d/%m/%Y') }}
    </div>
  </div>
</div>

<!-- Resumen Mensual por Empleado -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
          <i class="bi bi-people-fill"></i> Resumen Mensual por Empleado
        </h5>
      </div>
      <div class="card-body">
        {% if user_stats %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>#</th>
                <th>Usuario</th>
                <th>Nombre</th>
                <th>Rol</th>
                <th>Días Trabajados</th>
                <th>Horas Totales</th>
                <th>Promedio Diario</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for stat in user_stats %}
              <tr>
                <td>{{ loop.index }}</td>
                <td><strong>{{ stat.user.username }}</strong></td>
                <td>{{ stat.user.name }}</td>
                <td>
                  <span
                    class="badge {% if stat.user.role == 'admin' %}bg-danger{% else %}bg-primary{% endif %}"
                  >
                    {{ 'ADMIN' if stat.user.role == 'admin' else 'OPERADOR' }}
                  </span>
                </td>
                <td class="text-center">
                  <span class="badge bg-info fs-6">{{ stat.total_days }}</span>
                </td>
                <td class="text-end">
                  <strong class="text-primary"
                    >{{ stat.total_hours }} hs</strong
                  >
                </td>
                <td class="text-end">
                  <span class="text-success">{{ stat.avg_hours }} hs/día</span>
                </td>
                <td>
                  <a
                    href="{{ url_for('main.attendance_user_report', user_id=stat.user.id) }}"
                    class="btn btn-sm btn-info"
                    title="Ver reporte detallado"
                  >
                    <i class="bi bi-file-earmark-text"></i> Ver Detalle
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot class="table-secondary">
              <tr>
                <td colspan="4" class="text-end"><strong>TOTALES:</strong></td>
                <td class="text-center">
                  <strong>{{ user_stats|sum(attribute='total_days') }}</strong>
                </td>
                <td class="text-end">
                  <strong
                    >{{ "%.2f"|format(user_stats|sum(attribute='total_hours'))
                    }} hs</strong
                  >
                </td>
                <td colspan="2"></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Gráfico de Ranking (Visual) -->
        <div class="row mt-4">
          <div class="col-12">
            <h6><i class="bi bi-bar-chart"></i> Ranking de Horas Trabajadas</h6>
            {% for stat in user_stats[:5] %}
            <div class="mb-3">
              <div
                class="d-flex justify-content-between align-items-center mb-1"
              >
                <span><strong>{{ stat.user.name }}</strong></span>
                <span class="text-primary"
                  ><strong>{{ stat.total_hours }} hs</strong></span
                >
              </div>
              <div class="progress" style="height: 25px">
                {% set max_hours = user_stats[0].total_hours %} {% set
                percentage = (stat.total_hours / max_hours * 100) if max_hours >
                0 else 0 %}
                <div
                  class="progress-bar bg-primary"
                  role="progressbar"
                  style="width: {{ percentage }}%;"
                  aria-valuenow="{{ percentage }}"
                  aria-valuemin="0"
                  aria-valuemax="100"
                >
                  {{ "%.1f"|format(percentage) }}%
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        {% else %}
        <div class="text-center py-5 text-muted">
          <i class="bi bi-inbox" style="font-size: 3rem"></i>
          <p class="mt-3">No hay datos de asistencia para mostrar</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Tarjetas de Métricas -->
{% if user_stats %}
<div class="row mt-4">
  <div class="col-md-4">
    <div class="card text-center">
      <div class="card-body">
        <i class="bi bi-people text-primary" style="font-size: 3rem"></i>
        <h3 class="mt-3 mb-0">{{ user_stats|length }}</h3>
        <p class="text-muted">Empleados Activos</p>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card text-center">
      <div class="card-body">
        <i class="bi bi-clock-history text-success" style="font-size: 3rem"></i>
        <h3 class="mt-3 mb-0">
          {{ "%.0f"|format(user_stats|sum(attribute='total_hours')) }}
        </h3>
        <p class="text-muted">Horas Totales (Mes)</p>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card text-center">
      <div class="card-body">
        <i class="bi bi-calendar-check text-info" style="font-size: 3rem"></i>
        {% set total_days = user_stats|sum(attribute='total_days') %} {% set
        avg_days = (total_days / user_stats|length) if user_stats|length > 0
        else 0 %}
        <h3 class="mt-3 mb-0">{{ "%.1f"|format(avg_days) }}</h3>
        <p class="text-muted">Promedio Días/Empleado</p>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Análisis por Rol -->
{% if user_stats %}
<div class="row mt-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header bg-danger text-white">
        <h6 class="mb-0"><i class="bi bi-shield-lock"></i> Administradores</h6>
      </div>
      <div class="card-body">
        {% set admins = user_stats|selectattr('user.role', 'equalto',
        'admin')|list %} {% if admins %}
        <p><strong>Total:</strong> {{ admins|length }} admin(s)</p>
        <p>
          <strong>Horas totales:</strong> {{
          "%.2f"|format(admins|sum(attribute='total_hours')) }} hs
        </p>
        <p>
          <strong>Promedio:</strong> {{
          "%.2f"|format(admins|sum(attribute='total_hours') / admins|length) }}
          hs/admin
        </p>
        {% else %}
        <p class="text-muted">No hay datos de administradores</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h6 class="mb-0"><i class="bi bi-person-badge"></i> Operadores</h6>
      </div>
      <div class="card-body">
        {% set operators = user_stats|selectattr('user.role', 'equalto',
        'operador')|list %} {% if operators %}
        <p><strong>Total:</strong> {{ operators|length }} operador(es)</p>
        <p>
          <strong>Horas totales:</strong> {{
          "%.2f"|format(operators|sum(attribute='total_hours')) }} hs
        </p>
        <p>
          <strong>Promedio:</strong> {{
          "%.2f"|format(operators|sum(attribute='total_hours') /
          operators|length) }} hs/operador
        </p>
        {% else %}
        <p class="text-muted">No hay datos de operadores</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Acciones -->
<div class="row mt-4">
  <div class="col-12">
    <a href="{{ url_for('main.attendance_panel') }}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Volver al Panel
    </a>
    <a href="{{ url_for('main.attendance_history') }}" class="btn btn-primary">
      <i class="bi bi-journal-text"></i> Ver Historial
    </a>
    <a
      href="{{ url_for('main.attendance_export') }}?start_date={{ month_start.strftime('%Y-%m-%d') }}"
      class="btn btn-success"
    >
      <i class="bi bi-download"></i> Exportar Mes Actual
    </a>
  </div>
</div>

{% endblock %}
