{% extends "base.html" %} {% block content %}
<div class="row">
  <div class="col-12">
    <h2 class="text-white mb-4">
      <i class="bi bi-clock-history"></i> Control de Asistencias
    </h2>
  </div>
</div>

<!-- Tarjetas de Resumen -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card text-center">
      <div class="card-body">
        <i class="bi bi-people-fill text-primary" style="font-size: 3rem"></i>
        <h3 class="mt-3 mb-0">{{ active_users|length }}</h3>
        <p class="text-muted">Usuarios Activos Ahora</p>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card text-center">
      <div class="card-body">
        <i
          class="bi bi-calendar-check text-success"
          style="font-size: 3rem"
        ></i>
        <h3 class="mt-3 mb-0">{{ today_attendances|length }}</h3>
        <p class="text-muted">Asistencias Hoy</p>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card text-center">
      <div class="card-body">
        <i class="bi bi-clock text-info" style="font-size: 3rem"></i>
        <h3 class="mt-3 mb-0">{{ now.strftime('%H:%M') }}</h3>
        <p class="text-muted">Hora Actual</p>
      </div>
    </div>
  </div>
</div>

<!-- Usuarios Activos -->
{% if active_users %}
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">
          <i class="bi bi-circle-fill blink"></i> Usuarios Trabajando Ahora
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          {% for attendance in active_users %}
          <div class="col-md-6 col-lg-4">
            <div class="card border-success h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h5 class="mb-1">{{ attendance.user.name }}</h5>
                    <p class="text-muted mb-0">
                      <i class="bi bi-person-badge"></i> {{
                      attendance.user.username }}
                    </p>
                    <span
                      class="badge {% if attendance.user.role == 'admin' %}bg-danger{% else %}bg-primary{% endif %} mt-1"
                    >
                      {{ 'ADMIN' if attendance.user.role == 'admin' else
                      'OPERADOR' }}
                    </span>
                  </div>
                  <div class="badge bg-success fs-6">
                    <i class="bi bi-circle-fill"></i> ACTIVO
                  </div>
                </div>

                <hr />

                <div class="mb-2">
                  <small class="text-muted">
                    <i class="bi bi-box-arrow-in-right"></i> Entrada: </small
                  ><br />
                  <strong
                    >{{ attendance.login_time.strftime('%H:%M:%S') }}</strong
                  >
                </div>

                <div class="mb-2">
                  <small class="text-muted">
                    <i class="bi bi-stopwatch"></i> Tiempo transcurrido: </small
                  ><br />
                  <strong class="text-primary"
                    >{{ attendance.get_duration_text() }}</strong
                  >
                </div>

                <div class="text-muted">
                  <small
                    ><i class="bi bi-calendar3"></i> {{
                    attendance.login_time.strftime('%d/%m/%Y') }}</small
                  >
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Asistencias del Día -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
          <i class="bi bi-calendar-day"></i> Asistencias de Hoy - {{
          now.strftime('%d/%m/%Y') }}
        </h5>
      </div>
      <div class="card-body">
        {% if today_attendances %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Nombre</th>
                <th>Rol</th>
                <th>Hora Entrada</th>
                <th>Hora Salida</th>
                <th>Tiempo Trabajado</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              {% for attendance in today_attendances %}
              <tr>
                <td><strong>{{ attendance.user.username }}</strong></td>
                <td>{{ attendance.user.name }}</td>
                <td>
                  <span
                    class="badge {% if attendance.user.role == 'admin' %}bg-danger{% else %}bg-primary{% endif %}"
                  >
                    {{ 'ADMIN' if attendance.user.role == 'admin' else
                    'OPERADOR' }}
                  </span>
                </td>
                <td>{{ attendance.login_time.strftime('%H:%M:%S') }}</td>
                <td>
                  {% if attendance.logout_time %} {{
                  attendance.logout_time.strftime('%H:%M:%S') }} {% else %}
                  <span class="text-success">En curso...</span>
                  {% endif %}
                </td>
                <td>
                  <strong
                    class="{% if attendance.is_active() %}text-primary{% else %}text-success{% endif %}"
                  >
                    {{ attendance.get_duration_text() }}
                  </strong>
                </td>
                <td>
                  {% if attendance.is_active() %}
                  <span class="badge bg-success">
                    <i class="bi bi-circle-fill"></i> Activo
                  </span>
                  {% else %}
                  <span class="badge bg-secondary">
                    <i class="bi bi-check-circle"></i> Finalizado
                  </span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-5 text-muted">
          <i class="bi bi-inbox" style="font-size: 3rem"></i>
          <p class="mt-3">No hay asistencias registradas hoy</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Acciones -->
<div class="row">
  <div class="col-12">
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Volver al Inicio
    </a>
    <a href="{{ url_for('main.attendance_history') }}" class="btn btn-primary">
      <i class="bi bi-journal-text"></i> Ver Historial Completo
    </a>
    <a href="{{ url_for('main.attendance_stats') }}" class="btn btn-info">
      <i class="bi bi-graph-up"></i> Estadísticas
    </a>
    <a href="{{ url_for('main.attendance_export') }}" class="btn btn-success">
      <i class="bi bi-download"></i> Exportar CSV
    </a>
  </div>
</div>

<style>
  @keyframes blink {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.3;
    }
  }

  .blink {
    animation: blink 2s infinite;
  }
</style>

<script>
  // Auto-actualizar cada 30 segundos
  setTimeout(function () {
    location.reload();
  }, 30000);
</script>

{% endblock %}
